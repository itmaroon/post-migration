<?php
/*
Plugin Name:  POST MIGRATION
Description:  This plugin allows you to export post data along with associated media, revisions, and comments into a ZIP file and port it to another WordPress site.
Requires at least: 6.4
Requires PHP:      8.2
Version:      1.0.1
Author:       Web Creator ITmaroon
Author URI:   https://itmaroon.net
License:      GPL v2 or later
License URI:  https://www.gnu.org/licenses/gpl-2.0.html
Text Domain:  post-migration
Domain Path:  /languages
*/

if (! defined('ABSPATH')) exit;

require_once __DIR__ . '/vendor/itmar/loader-package/src/register_autoloader.php';

//„Éó„É≠„Ç∞„É¨„Çπ„Ç™„Éº„Éê„Éº„É¨„Ç§„ÅÆ„Ç§„É≥„Çπ„Çø„É≥„Çπ„ÇíÂèñÂæó„Åó„Å¶„Åä„Åè
\Itmar\BlockClassPackage\ItmarProgressClass::get_instance();

//CSSÁ≠â„ÅÆË™≠Ëæº
function itmar_post_tranfer_script_init($hook)
{
  // 'post-migration_page' „ÇíÂê´„ÇÄÁÆ°ÁêÜÁîªÈù¢„Åß„ÅÆ„Åø„Çπ„ÇØ„É™„Éó„Éà„ÇíË™≠„ÅøËæº„ÇÄ
  if (strpos($hook, 'post-migration_page') === false) {
    return;
  }
  //Áã¨Ëá™CSS„ÅÆË™≠„ÅøËæº„Åø
  $css_path = plugin_dir_path(__FILE__) . 'css/transfer.css';
  wp_enqueue_style('transfer_handle', plugins_url('/css/transfer.css', __FILE__), array(), filemtime($css_path), 'all');

  // zip-js „É©„Ç§„Éñ„É©„É™„ÇíË™≠„ÅøËæº„ÇÄ
  wp_enqueue_script(
    'zip-js',
    plugin_dir_url(__FILE__) . 'assets/js/jszip.min.js',
    array(), // ‰æùÂ≠òÈñ¢‰øÇ„Å™„Åó
    '3.10.1', // „Éê„Éº„Ç∏„Éß„É≥
    true // „Éï„ÉÉ„Çø„Éº„ÅßË™≠„ÅøËæº„ÇÄ
  );

  // FileSaver
  wp_enqueue_script(
    'file-saver',
    plugin_dir_url(__FILE__) . 'assets/js/FileSaver.min.js',
    array(),
    '2.0.5',
    true
  );

  // WordPress „Ç≥„Ç¢„ÅÆ api-fetch
  wp_enqueue_script('wp-api-fetch');

  //„Åì„ÅÆ„Éó„É©„Ç∞„Ç§„É≥Â∞ÇÁî®„ÅÆJS„Çí„Ç®„É≥„Ç≠„É•„Éº
  $script_path = plugin_dir_path(__FILE__) . 'assets/js/post-mi-script.js';
  wp_enqueue_script('post-mi-handle', plugin_dir_url(__FILE__) . 'assets/js/post-mi-script.js', array('jquery'), filemtime($script_path), true);
  //JS„ÅÆÁøªË®≥„Éï„Ç°„Ç§„É´„ÅÆË™≠„ÅøËæº„Åø
  $lang_path = plugin_dir_path(__FILE__) . 'languages';
  wp_set_script_translations(
    'post-mi-handle',
    'post-migration',
    $lang_path
  );
  //JSÁî®„ÅÆ„Éë„É©„É°„Éº„Çø„ÇíË™≠„ÅøËæº„ÇÄ
  wp_localize_script('post-mi-handle', 'itmar_vars', [
    'ajaxurl' => admin_url('admin-ajax.php'),
    'nonce' => wp_create_nonce('itmar-ajax-nonce'),
  ]);
}
add_action('admin_enqueue_scripts', 'itmar_post_tranfer_script_init');



/**
 * „Äå„ÉÑ„Éº„É´„Äç„Å´„É°„Éã„É•„Éº„ÇíËøΩÂä†
 */
function itmar_post_tranfer_add_admin_menu()
{
  // Ë¶™„É°„Éã„É•„ÉºÔºà„ÉÑ„Éº„É´„É°„Éã„É•„Éº„ÅÆ‰∏ã„Å´ËøΩÂä†Ôºâ
  add_menu_page(
    'POST MIGRATION', // Ë®≠ÂÆöÁîªÈù¢„ÅÆ„Éö„Éº„Ç∏„Çø„Ç§„Éà„É´.
    'POST MIGRATION', // ÁÆ°ÁêÜÁîªÈù¢„É°„Éã„É•„Éº„Å´Ë°®Á§∫„Åï„Çå„ÇãÂêçÂâç.
    'manage_options',
    'itmar_post_tranfer_menu', // „É°„Éã„É•„Éº„ÅÆ„Çπ„É©„ÉÉ„Ç∞.
    '', //„Ç≥„Éº„É´„Éê„ÉÉ„ÇØ„ÅØÁ©∫
    'dashicons-admin-tools',  // „Ç¢„Ç§„Ç≥„É≥
    75                        // „É°„Éã„É•„Éº„ÅÆ‰ΩçÁΩÆ
  );

  // „Äå„Ç§„É≥„Éù„Éº„Éà„Äç„Çµ„Éñ„É°„Éã„É•„Éº
  add_submenu_page(
    'itmar_post_tranfer_menu',        // Ë¶™„É°„Éã„É•„Éº„ÅÆ„Çπ„É©„ÉÉ„Ç∞
    __('Import', 'post-migration'),      // „Éö„Éº„Ç∏„Çø„Ç§„Éà„É´
    __('import', 'post-migration'),             // „É°„Éã„É•„Éº„Çø„Ç§„Éà„É´
    'manage_options',         // Ê®©Èôê
    'itmar_post_tranfer_import',       // „Çπ„É©„ÉÉ„Ç∞
    'itmar_post_tranfer_import_page'   // „Ç≥„Éº„É´„Éê„ÉÉ„ÇØÈñ¢Êï∞
  );

  // „Äå„Ç®„ÇØ„Çπ„Éù„Éº„Éà„Äç„Çµ„Éñ„É°„Éã„É•„Éº
  add_submenu_page(
    'itmar_post_tranfer_menu',        // Ë¶™„É°„Éã„É•„Éº„ÅÆ„Çπ„É©„ÉÉ„Ç∞
    __('Export', 'post-migration'),      // „Éö„Éº„Ç∏„Çø„Ç§„Éà„É´
    __('export', 'post-migration'),             // „É°„Éã„É•„Éº„Çø„Ç§„Éà„É´
    'manage_options',         // Ê®©Èôê
    'itmar_post_tranfer_export',       // „Çπ„É©„ÉÉ„Ç∞
    'itmar_post_tranfer_export_page'   // „Ç≥„Éº„É´„Éê„ÉÉ„ÇØÈñ¢Êï∞
  );

  // „Çµ„Éñ„É°„Éã„É•„Éº„ÇíÂâäÈô§
  remove_submenu_page('itmar_post_tranfer_menu', 'itmar_post_tranfer_menu');
}
add_action('admin_menu', 'itmar_post_tranfer_add_admin_menu');

/**
 * „Ç§„É≥„Éù„Éº„Éà„ÅÆ„Éï„É≠„É≥„Éà„Ç®„É≥„ÉâÂá¶ÁêÜ
 */
function itmar_post_tranfer_import_page()
{

  // Ê®©Èôê„ÉÅ„Çß„ÉÉ„ÇØ.
  if (! current_user_can('manage_options')) {
    wp_die(esc_html__('You do not have sufficient permissions to access this page.', 'post-migration'));
  }

?>
  <div class="wrap">
    <h1><?php echo esc_html__("Post Data Import", "post-migration"); ?></h1>
    <form id="inportForm">

      <table class="form-table">
        <tr>
          <th><label for="import_file"><?php echo esc_html__("ZIP file to import", "post-migration"); ?></label></th>
          <td>
            <input type="file" name="import_file" id="import_file" accept=".zip" required>
          </td>
        </tr>

        <!-- „Ç§„É≥„Éù„Éº„ÉàÊñπÊ≥ïÈÅ∏Êäû -->
        <tr>
          <th><?php echo esc_html__("How to import", "post-migration"); ?></th>
          <td>
            <label>
              <input type="radio" name="import_mode" value="create" checked> <?php echo esc_html__("Add new record", "post-migration"); ?>
            </label><br>
            <label>
              <input type="radio" name="import_mode" value="update"> <?php echo esc_html__("Override by ID", "post-migration"); ?>
            </label>

          </td>
        </tr>
      </table>

      <p class="submit">
        <input type="submit" name="submit_import" class="button button-primary" value="<?php echo esc_attr__("Start Import", "post-migration"); ?>">
      </p>
    </form>

    <div class='inport_result' style="display: none;">
      <h2><?php echo esc_html__("Import Result", "post-migration") ?></h2>
      <table class="widefat">
        <thead>
          <tr>
            <th>ID</th>
            <th><?php echo esc_html__("Title", "post-migration") ?></th>
            <th><?php echo esc_html__("Post Type", "post-migration") ?></th>
            <th><?php echo esc_html__("Result", "post-migration") ?></th>
          </tr>
        </thead>
        <tbody class="post_trns_tbody">
        </tbody>
      </table>
    </div>

  </div>
<?php
}

//„Ç§„É≥„Éù„Éº„Éà„É°„Ç§„É≥„Éá„Éº„Çø„ÅÆÈÄêÊ¨°Âá¶ÁêÜÔºàÈùûÂêåÊúüÔºâ
function itmar_post_data_fetch()
{
  // WordPress „ÅÆ nonce „ÉÅ„Çß„ÉÉ„ÇØÔºà„Çª„Ç≠„É•„É™„ÉÜ„Ç£ÂØæÁ≠ñÔºâ
  check_ajax_referer('itmar-ajax-nonce', 'nonce');
  // **„Ç≠„É£„É≥„Çª„É´„Éï„É©„Ç∞„ÉÅ„Çß„ÉÉ„ÇØ**
  $cancel_flag = get_option('start_cancel', false);
  if ($cancel_flag) {
    wp_send_json(["result" => "cancel", "message" => __("Processing has been aborted", "post-migration")]);
    exit;
  }
  $db_obj = new \Itmar\WpsettingClassPackage\ItmarDbAction();

  // **JSON „Çí„Éá„Ç≥„Éº„Éâ**
  $post_data = [];

  if (isset($_POST['post_data'])) {
    $raw_json = wp_unslash($_POST['post_data']); // phpcs:ignore WordPress.Security.ValidatedSanitizedInput.InputNotSanitized
    $decoded  = json_decode($raw_json, true);

    if (is_array($decoded)) {
      $post_data = $decoded;
    }
  }

  // **„Éá„Ç≥„Éº„Éâ„Ç®„É©„Éº„ÉÅ„Çß„ÉÉ„ÇØ**
  if (!is_array($post_data) || empty($post_data)) {
    wp_send_json_error(["message" => __("Incorrect data", "post-migration")]);
    exit;
  }
  //„Ç§„É≥„Éù„Éº„Éà„É¢„Éº„Éâ
  $import_mode = isset($_POST['import_mode']) ? sanitize_text_field(wp_unslash($_POST['import_mode'])) : "update";

  //„É°„Éá„Ç£„Ç¢„Éï„Ç°„Ç§„É´
  // üìå `media_files` „ÇíÂèñÂæó

  if (
    isset($_FILES['media_files']) &&
    is_array($_FILES['media_files']) &&
    isset($_FILES['media_files']['name']) &&
    is_array($_FILES['media_files']['name'])
  ) {
    $file_count = count($_FILES['media_files']['name']);

    for ($i = 0; $i < $file_count; $i++) {
      // ÂêÑ„Éï„Ç£„Éº„É´„Éâ„ÅÆÂ≠òÂú®„Çí„ÉÅ„Çß„ÉÉ„ÇØ„Åó„Å¶„Åã„ÇâÂá¶ÁêÜ
      $name      = isset($_FILES['media_files']['name'][$i]) ? sanitize_file_name(wp_unslash($_FILES['media_files']['name'][$i])) : '';
      $type      = isset($_FILES['media_files']['type'][$i]) ? sanitize_mime_type(wp_unslash($_FILES['media_files']['type'][$i])) : '';
      $tmp_name = isset($_FILES['media_files']['tmp_name'][$i])
        ? $_FILES['media_files']['tmp_name'][$i] // phpcs:ignore WordPress.Security.ValidatedSanitizedInput.InputNotSanitized
        : '';
      $error     = isset($_FILES['media_files']['error'][$i]) ? (int) $_FILES['media_files']['error'][$i] : 1; // „Éá„Éï„Ç©„É´„Éà„Çí„Ç®„É©„ÉºÊâ±„ÅÑ„Å´
      $size      = isset($_FILES['media_files']['size'][$i]) ? absint($_FILES['media_files']['size'][$i]) : 0;
      // „Éï„Ç°„Ç§„É´ÊßãÈÄ†ÂÜçÁèæÁî®„Å´ full_path „ÇíÂèñÂæó„ÄÇ‰øùÂ≠ò/Ë°®Á§∫ÁõÆÁöÑ„Åß‰ΩøÁî®„ÄÇ
      $full_path = isset($_FILES['media_files']['full_path'][$i])
        ? $_FILES['media_files']['full_path'][$i] // phpcs:ignore WordPress.Security.ValidatedSanitizedInput.InputNotSanitized
        : '';

      // „Ç®„É©„Éº„Éï„Ç°„Ç§„É´„ÅØ„Çπ„Ç≠„ÉÉ„Éó„Åó„Å¶„ÇÇ„Çà„ÅÑ
      if ($error === 0 && $name && $tmp_name) {
        $sanitized_files[] = [
          'name'       => $name,
          'type'       => $type,
          'tmp_name'   => $tmp_name,
          'error'      => $error,
          'size'       => $size,
          'full_path'  => $full_path,
        ];
      }
    }
  }


  $result = $db_obj->json_import_data($post_data, $sanitized_files, $import_mode);
  wp_send_json($result);
}

add_action('wp_ajax_post_data_fetch', 'itmar_post_data_fetch');
add_action('wp_ajax_nopriv_post_data_fetch', 'itmar_post_data_fetch');




/**
 * „Ç®„ÇØ„Çπ„Éù„Éº„Éà„ÅÆ„Éï„É≠„É≥„Éà„Ç®„É≥„ÉâÂá¶ÁêÜ
 */

function itmar_post_tranfer_export_page()
{

  // Ê®©Èôê„ÉÅ„Çß„ÉÉ„ÇØ.
  if (! current_user_can('manage_options')) {
    wp_die(esc_html__('You do not have sufficient permissions to access this page.', 'post-migration'));
  }

?>
  <div class="wrap">

    <div class="form-container">
      <form id="exportForm" method="post">
        <?php wp_nonce_field('export_action', 'itmar_export_nonce'); ?>
        <input type="hidden" name="export_action" value="export_json">

        <!-- „Éò„ÉÉ„ÉÄ„Éº„ÇíÂõ∫ÂÆö -->
        <div class="fixed-header">
          <h1><?php echo esc_html__("Post Data Custom Export", "post-migration") ?></h1>
          <p><?php echo esc_html__("Select the articles you want to export.", "post-migration") ?></p>
          <label>
            <input type="checkbox" id="include_custom_fields" name="include_custom_fields" value="1">
            <?php echo esc_html__("Include custom fields", "post-migration") ?>
          </label>
          <label>
            <input type="checkbox" id="include_revisions" name="include_revisions" value="1">
            <?php echo esc_html__("Include revisions", "post-migration") ?>
          </label>
          <label>
            <input type="checkbox" id="include_comments" name="include_comments" value="1">
            <?php echo esc_html__("Include comments", "post-migration") ?>
          </label>
        </div>

        <?php
        // „Åô„Åπ„Å¶„ÅÆ„Ç´„Çπ„Çø„É†ÊäïÁ®ø„Çø„Ç§„Éó„ÇíÂèñÂæóÔºà„É°„Éá„Ç£„Ç¢ "attachment" „ÇíÈô§Â§ñÔºâ
        $all_post_types = get_post_types(['public' => true], 'objects');

        // ÊäïÁ®ø„Çø„Ç§„Éó„ÅÆÈ†ÜÂ∫è„ÇíÂ§âÊõ¥ÔºàÊäïÁ®ø ‚Üí „Ç´„Çπ„Çø„É†ÊäïÁ®ø ‚Üí Âõ∫ÂÆö„Éö„Éº„Ç∏Ôºâ
        $ordered_post_types = [];
        if (isset($all_post_types['post'])) {
          $ordered_post_types['post'] = $all_post_types['post']; // ÊäïÁ®ø„ÇíÊúÄÂàù„Å´
          unset($all_post_types['post']);
        }
        if (isset($all_post_types['page'])) {
          $page_type = $all_post_types['page']; // Âõ∫ÂÆö„Éö„Éº„Ç∏„ÇíÊúÄÂæå„Å´
          unset($all_post_types['page']);
        }

        // „Ç´„Çπ„Çø„É†ÊäïÁ®ø„Çø„Ç§„Éó„ÇíÊÆã„Çä„ÅÆÊäïÁ®ø„Çø„Ç§„Éó„Å®„Åó„Å¶Ê†ºÁ¥ç
        foreach ($all_post_types as $key => $type) {
          if ($key !== 'attachment') { // „É°„Éá„Ç£„Ç¢Ôºà"attachment"Ôºâ„ÇíÈô§Â§ñ
            $ordered_post_types[$key] = $type;
          }
        }

        // Âõ∫ÂÆö„Éö„Éº„Ç∏„ÇíÊúÄÂæå„Å´ËøΩÂä†
        if (isset($page_type)) {
          $ordered_post_types['page'] = $page_type;
        }

        // ÊäïÁ®ø„Çø„Ç§„Éó„Åî„Å®„Å´Ë®ò‰∫ã‰∏ÄË¶ß„ÇíË°®Á§∫
        foreach ($ordered_post_types as $post_type) {
          // This GET param is only used for pagination display, not data processing.
          // phpcs:ignore WordPress.Security.NonceVerification.Recommended
          $current_page = isset($_GET["paged_{$post_type->name}"]) ? max(1, intval($_GET["paged_{$post_type->name}"])) : 1;
          $posts_per_page = 10;
          $offset = ($current_page - 1) * $posts_per_page;

          $query_args = [
            'post_type'      => $post_type->name,
            'posts_per_page' => $posts_per_page,
            'offset'         => $offset,
          ];
          $posts = get_posts($query_args);
          $total_posts = wp_count_posts($post_type->name)->publish;
          $total_pages = ceil($total_posts / $posts_per_page);

          if ($posts) {
            echo '<h2>' . esc_html($post_type->label) . '</h2>';
            // „Åô„Åπ„Å¶„ÅÆ„É¨„Ç≥„Éº„Éâ„ÇíÈÅ∏Êäû „ÉÅ„Çß„ÉÉ„ÇØ„Éú„ÉÉ„ÇØ„Çπ„ÇíËøΩÂä†
            echo "<label class='select-all-posts'><input type='checkbox' name='export_types[]' value='" . esc_html($post_type->name) . "'>" . esc_html__(' Select all records', 'post-migration') . "</label>";
            // ÊäïÁ®ø„Çø„Ç§„Éó„Å´Á¥ê„Å•„Åè„Çø„ÇØ„ÇΩ„Éé„Éü„Éº„ÇíÂèñÂæóÔºà„Éò„ÉÉ„ÉÄ„ÉºÁî®Ôºâ
            $taxonomies = get_object_taxonomies($post_type->name, 'objects');
            // **post_format „ÇíÈÖçÂàó„Åã„ÇâÂâäÈô§**
            unset($taxonomies['post_format']);
            //ÊäïÁ®ø„ÅÆ„ÉÜ„Éº„Éñ„É´
            echo "<table class='widefat striped'>";
            echo "<thead><tr><th><input type='checkbox' id='select-all-" . esc_html($post_type->name) . "'></th><th>" . esc_html__('Title', 'post-migration') . "</th><th>" . esc_html__('Featured', 'post-migration') . "</th>";
            // „Çø„ÇØ„ÇΩ„Éé„Éü„Éº„Åî„Å®„Å´„Éò„ÉÉ„ÉÄ„Éº„ÇíËøΩÂä†
            foreach ($taxonomies as $taxonomy) {
              echo "<th>" . esc_html($taxonomy->label) . "</th>";
            }
            echo "<th>" . esc_html__('Updated on', 'post-migration') . "</th></tr></thead>";
            echo "<tbody>";

            foreach ($posts as $post) {
              // „Ç¢„Ç§„Ç≠„É£„ÉÉ„ÉÅÁîªÂÉè„ÇíÂèñÂæó
              $thumbnail = get_the_post_thumbnail($post->ID, 'thumbnail');
              // Â§âÊõ¥Êó•
              $modified_date = get_the_modified_date('Y-m-d', $post->ID);

              echo "<tr>";
              echo "<td><input type='checkbox' name='export_posts[]' value='" . esc_html($post->ID) . "'></td>";
              echo "<td>" . esc_html($post->post_title) . "</td>";
              echo '<td>' . ($thumbnail ? wp_kses($thumbnail, array('img' => array('src' => true, 'alt' => true, 'width' => true, 'height' => true, 'class' => true))) : esc_html__('None', 'post-migration')) . '</td>';

              // „Çø„ÇØ„ÇΩ„Éé„Éü„Éº„Åî„Å®„ÅÆ„Çø„Éº„É†„ÇíÂèñÂæó„Åó„ÄÅ„Ç´„É≥„ÉûÂå∫Âàá„Çä„ÅßË°®Á§∫
              foreach ($taxonomies as $taxonomy) {
                $terms = get_the_terms($post->ID, $taxonomy->name);
                if (!empty($terms) && !is_wp_error($terms)) {
                  $term_list = implode(', ', wp_list_pluck($terms, 'name'));
                } else {
                  $term_list = '-';
                }
                echo "<td>" . esc_html($term_list) . "</td>";
              }

              echo "<td>" . esc_html($modified_date) . "</td>";
              echo "</tr>";
            }

            echo "</tbody></table>";
            // „Éö„Éº„Ç∏„Éç„Éº„Ç∑„Éß„É≥„ÅÆË°®Á§∫
            if ($total_pages > 1) {
              echo "<div class='tablenav'>";
              echo "<div class='tablenav-pages'>";

              // Ââç„ÅÆ„Éö„Éº„Ç∏
              if ($current_page > 1) {
                // This GET param is only used for pagination display, not data processing.
                // phpcs:ignore WordPress.Security.NonceVerification.Recommended
                $page_param     = isset($_GET['page']) ? sanitize_key(wp_unslash($_GET['page'])) : '';
                $post_type_name = esc_attr($post_type->name);
                $prev_page      = $current_page - 1;
                $prev_url       = '?page=' . $page_param . '&paged_' . $post_type_name . '=' . $prev_page;

                echo '<a class="button" href="' . esc_url($prev_url) . '">¬´ ' . esc_html__('Before', 'post-migration') . '</a>';
              }

              // „Éö„Éº„Ç∏Áï™Âè∑Ë°®Á§∫
              echo esc_html__('Page', 'post-migration') . ' ' . esc_html($current_page) . ' / ' . esc_html($total_pages) . ' ';

              // Ê¨°„ÅÆ„Éö„Éº„Ç∏
              if ($current_page < $total_pages) {
                // This GET param is only used for pagination display, not data processing.
                // phpcs:ignore WordPress.Security.NonceVerification.Recommended
                $page_param     = isset($_GET['page']) ? sanitize_key(wp_unslash($_GET['page'])) : '';
                $post_type_name = esc_attr($post_type->name);
                $next_page      = $current_page + 1;
                $next_url       = '?page=' . $page_param . '&paged_' . $post_type_name . '=' . $next_page;

                echo '<a class="button" href="' . esc_url($next_url) . '">' . esc_html__('Next', 'post-migration') . ' ¬ª</a>';
              }

              echo '</div></div>';
            }
          }
        }
        //‰ªñ„ÅÆ„Éö„Éº„Ç∏„ÅßÈÅ∏Êäû„Åï„Çå„ÅüÊäïÁ®øID„ÇÇÂê´„ÇÅ„Å¶Ê†ºÁ¥ç„Åô„ÇãinputË¶ÅÁ¥†
        echo "<input type='hidden' name='all_export_posts'>"
        ?>

        <p class='footer_exec'><input type="submit" name="export_selected" class="button button-primary" value="ÈÅ∏Êäû„Åó„ÅüË®ò‰∫ã„Çí„Ç®„ÇØ„Çπ„Éù„Éº„Éà"></p>
      </form>
    </div>

  </div>

<?php
}

// „Ç®„ÇØ„Çπ„Éù„Éº„Éà„ÅÆ„Çµ„Éº„Éê„Éº„Çµ„Ç§„ÉâÂá¶ÁêÜ
//„Ç®„ÇØ„Çπ„Éù„Éº„ÉàÂØæË±°„ÅÆÊäïÁ®øID„ÅÆÂèñÂæó
add_action('wp_ajax_itmar_export_ids', 'itmar_post_tranfer_export_ids');
function itmar_post_tranfer_export_ids()
{
  check_ajax_referer('itmar-ajax-nonce', 'nonce');
  //ÊúÄÂàù„Å´export_data.json„ÇíÂâäÈô§„Åó„Å¶„Åä„Åè
  require_once ABSPATH . 'wp-admin/includes/file.php';
  global $wp_filesystem;
  if (! WP_Filesystem()) {
    wp_die('WP_Filesystem „ÅÆÂàùÊúüÂåñ„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ');
  }
  $upload_dir   = wp_upload_dir();
  $json_path    = $upload_dir['basedir'] . '/export_data.json';

  if ($wp_filesystem->exists($json_path)) {
    $wp_filesystem->delete($json_path);
  }

  $str_post_ids = isset($_POST['all_export_posts']) ? sanitize_text_field(wp_unslash($_POST['all_export_posts'])) : '';
  $post_ids     = explode(',', $str_post_ids);

  $selected_post_types = isset($_POST['export_types']) && is_array($_POST['export_types'])
    ? array_map('sanitize_key', wp_unslash($_POST['export_types']))
    : [];

  $selected_posts = [];

  $all_selected_posts = array_merge(...array_map(function ($post_type) {
    return array_map('strval', get_posts([
      'post_type'      => $post_type,
      'posts_per_page' => -1,
      'fields'         => 'ids',
    ]));
  }, $selected_post_types));

  $selected_posts = array_values(array_unique(array_merge($post_ids, $all_selected_posts)));
  $selected_posts = array_values(array_diff($selected_posts, $selected_post_types));

  //„É™„Éì„Ç∏„Éß„É≥„Çí„Ç®„ÇØ„Çπ„Éù„Éº„Éà„Å´Âê´„ÇÅ„Çã„Åã
  $include_revisions     = isset($_POST['include_revisions']);

  if ($include_revisions) {
    $selected_posts_rev = [];
    foreach ($selected_posts as $post_id) {
      $selected_posts_rev[] = $post_id;
      $rev_ids              = get_posts([
        'post_type'   => 'revision',
        'post_status' => 'any',
        'post_parent' => $post_id,
        'numberposts' => -1,
        'fields'      => 'ids',
      ]);
      if (! empty($rev_ids)) {
        $selected_posts_rev = array_merge($selected_posts_rev, $rev_ids);
      }
    }
    $selected_posts = array_values($selected_posts_rev);
  }

  //„Éá„Éº„Çø„ÇíËøî„Åô
  wp_send_json_success([
    'selected_posts'     => $selected_posts,
  ]);
}


//ÊäïÁ®øID„Åî„Å®„Å´ZIP„Éï„Ç°„Ç§„É´„Å´„Ç®„ÇØ„Çπ„Éù„Éº„Éà
add_action('wp_ajax_itmar_export_json', 'itmar_post_tranfer_export_json');
function itmar_post_tranfer_export_json()
{
  check_ajax_referer('itmar-ajax-nonce', 'nonce');

  // ÂøÖÈ†àÊÉÖÂ†±ÂèñÂæó
  $post_id = isset($_POST['post_id']) ? absint($_POST['post_id']) : 0;
  if (! $post_id) {
    wp_send_json_error(['message' => 'Invalid post_id']);
  }

  $db_obj = new \Itmar\WpsettingClassPackage\ItmarDbAction();

  //„Ç™„Éó„Ç∑„Éß„É≥„ÅÆ„Éï„É©„Ç∞
  $include_custom_fields = isset($_POST['include_custom_fields']);
  $include_comments      = isset($_POST['include_comments']);
  //„É°„Éá„Ç£„Ç¢URL‰øùÂ≠òÈÖçÂàó
  $media_urls = [];

  $post = get_post($post_id);
  if (! $post) {
    wp_send_json_error(['message' => 'Post not found']);
  }

  $post_data = [
    'ID'            => $post->ID,
    'title'         => $post->post_title,
    'content'       => $post->post_content,
    'excerpt'       => $post->post_excerpt,
    'date'          => $post->post_date,
    'modified'      => $post->post_modified,
    'author'        => get_the_author_meta('display_name', $post->post_author),
    'post_name'     => $post->post_name,
    'post_type'     => $post->post_type,
    'post_status'   => $post->post_status,
    'post_parent'   => $post->post_parent,
    'thumbnail_url' => get_the_post_thumbnail_url($post->ID, 'full'),
    'thumbnail_path' => null,
    'terms'         => [],
  ];
  // „Çø„ÇØ„ÇΩ„Éé„Éü„Éº
  $taxonomies = get_object_taxonomies($post->post_type, 'names');
  foreach ($taxonomies as $taxonomy) {
    $terms = get_the_terms($post->ID, $taxonomy);
    $post_data['terms'][$taxonomy] = ! is_wp_error($terms) && ! empty($terms) ? wp_list_pluck($terms, 'name') : [];
  }
  // „Ç´„Çπ„Çø„É†„Éï„Ç£„Éº„É´„Éâ
  if ($include_custom_fields) {
    $custom_fields        = get_post_meta($post->ID);
    $registered_meta_keys = get_registered_meta_keys('post', $post->post_type);

    foreach ($custom_fields as $key => $value) {
      if ($db_obj->is_acf_active()) {
        if (strpos($key, '_') !== 0) {
          $field_ID     = $db_obj->get_acf_field_key($key);
          $field_object = get_field_object($field_ID, $post->ID);

          if ($field_object && isset($field_object['type'])) {
            if (in_array($field_object['type'], ['image', 'file'], true)) {
              $val        = get_field($key, $post->ID);
              $media_url  = is_numeric($val) ? wp_get_attachment_url($val) : (is_array($val) && isset($val['url']) ? $val['url'] : $val);
              if ($media_url) {
                $relative_path                    = 'exported_media/' . basename($media_url);
                $post_data['acf_fields'][$key] = $relative_path;
                $media_urls[] = $media_url;
              }
            } elseif ($field_object['type'] === 'group') {
              $post_data['acf_fields'][$key] = '_group';
            } else {
              $post_data['acf_fields'][$key] = maybe_unserialize($value[0]);
            }
          } elseif (array_key_exists($key, $registered_meta_keys)) {
            $post_data['custom_fields'][$key] = maybe_unserialize($value[0]);
          }
        }
      } else {
        $post_data['custom_fields'][$key] = maybe_unserialize($value[0]);
      }
    }
  }
  // „Ç≥„É°„É≥„Éà
  if ($include_comments) {
    $comments               = $db_obj->get_comments_with_meta($post->ID);
    $post_data['comments']  = maybe_unserialize($comments);
  }
  // „Ç¢„Ç§„Ç≠„É£„ÉÉ„ÉÅÁîªÂÉè
  if ($post_data['thumbnail_url']) {
    $image_filename              = basename($post_data['thumbnail_url']);
    $post_data['thumbnail_path'] = 'exported_media/' . $image_filename;
    $media_urls[] = $post_data['thumbnail_url'];
  }
  // Êú¨Êñá‰∏≠„ÅÆ„É°„Éá„Ç£„Ç¢
  $content_media_urls = itmar_extract_media_urls($post->post_content);
  $modified_content   = $post_data['content'];
  foreach ($content_media_urls as $media_url) {
    $relative_path   = 'exported_media/' . basename($media_url);
    $modified_content = str_replace($media_url, $relative_path, $modified_content);
    $media_urls[] = $media_url;
  }

  $post_data['content'] = $modified_content;

  wp_send_json_success(['json' => $post_data, 'media_urls' => $media_urls]);
}

//„Ç≥„É≥„ÉÜ„É≥„ÉÑ„Åã„Çâ„É°„Éá„Ç£„Ç¢URL„ÇíÊäú„ÅçÂá∫„ÅôÈñ¢Êï∞
function itmar_extract_media_urls($content)
{
  $media_urls = [];

  // ÁîªÂÉè„Éª„É°„Éá„Ç£„Ç¢URL„ÇíÊ≠£Ë¶èË°®Áèæ„ÅßÊäΩÂá∫
  preg_match_all('/https?:\/\/[^\"\'\s]+(?:jpg|jpeg|png|gif|mp4|mp3|pdf)/i', $content, $matches);
  // preg_match_all(
  //   '#https?://(?![^"\']*exported_media/)[^"\']*?/([a-zA-Z0-9_\-]+(?:-[0-9]+)*\.(?:jpg|jpeg|png|gif|mp4|mp3|pdf))#i',
  //   $content,
  //   $matches
  // );
  if (!empty($matches[0])) {
    $media_urls = array_unique($matches[0]); // ÈáçË§á„ÇíÈô§Â§ñ
  }

  return $media_urls;
}
